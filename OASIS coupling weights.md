### Introduction
*from internal Met Office Wiki (by Miroslaw Andrejczuk):*
Models coupled with OASIS need re-gridding weights to interpolate between different grids. Although this information can be generated by OASIS itself it's much more efficient to have it generated externally and letting OASIS to use these weights only. For many applications SCRIP was used to generate re-gridding information. With the increased resolution, however, SCRIP becomes inefficient and another method must be used. ESMF (Earth System Modeling Framework) through a ESMF_RegridWeightGen program offers the functionality of generating weights for interpolation. EMSF is much faster than SCRIP and both input and output format are SCRIP (note that variable names in netcdf output generated by ESMF must be changed for OASIS). The disadvantage of ESMF, as far as generating conservative weights is concerned, is that it's not capable of generating other than first order conservative weights (SCRIP can generate second order conservative weights).

### Generation of weight files
Weights for a coupled models were successfully generated earlier with either SCRIP (low resolution) or ESMF (high resolution) and now used in GC3 configurations. Because there was not an established method to generate weights in a reproducible way a suite mi-al801 was developed (and is still under development) to allow generate weights and keep track of any changes in methodology and programs used. 
A simplified version of mi-al801 was created - mi-aw673 (u-[[bp550]] is a version of this suite@124350 in shared repository and can be run on Monsoon also). mi-aw673 uses only NEMO grid information and UM namelist. It generates full set of remapping weights using ESMF 7.1.
 
*Until now (June 2021), [[Alistair Sellar]] used this suite internally at the Met Office to generate the coupling weights for the Eocene based on the NEMO meshmask modified by [[Charlie Williams]]. The equivalent suite [[bp550]] is now available on [[NEXCS-MONSooN]] and will be tested in the following.*
 
#### Running OASIS weights suite [[bp550]] on [[NEXCS-MONSooN]]
 - [[Alistair Sellar]] created Eocene branch with latest grid/mask files from [[Charlie Williams]] (mail from 28/05/21)
 - this suite just uses NEMO meshmask file (**IGRID1**) and UM namelist with grid definition (**IGRID2**) as input at `suite conf > common > IGRID*`
 - get suite with command `rosie checkout u-bp550/eocene`
 - top-level suite directory contains file `notes.txt` with the following setup and post-processing instructions:

	```
	Suite depends on f90nml python package:
	$ cp ~mandrej/.local/lib/python2.7/site-packages/f90nml.pth ~/.local/lib/python2.7/site-packages
	(it would be advisable to copy the f90nml installation itself too)

	Output files are written to ~/cylc-run/u-bp550/share/data/20130105T0000Z

	After files made, renamed with
	rename DSTAREA DESTAREA *
	rename CONSERVE CONSERV *
	rename BILINEAR BILINEA *
	because the model expects different names from what the suite produces.
	Perhaps ask Mirek if this can be done in the suite?

	Comparing against
	/projects/ocean/hadgem3/grids/remapping/N96eg_eORCA1_GO6.1v2.2x
	the following appear to be missing
	rmp_atm3_to_tor1_BILINEA.nc
	rmp_tor1_to_atm3_BILINEA.nc
	but they don't seem to be needed.

	``` 
 - I created a local directory `python_pkg` and copied the f90nml installation with `cp -r /home/d02/mandrej/python_pkg/f90nml/ ~/python_pkg/`
 - I don't have a `~/.local/lib/python2.7/site-packages` directory to copy the path file `f90nml.pth ` to ... so I created it with ` mkdir -p ~/.local/lib/python2.7/site-packages` and then ran: `~mandrej/.local/lib/python2.7/site-packages/f90nml.pth ~/.local/lib/python2.7/site-packages
 - I changed the file path within this file to `/home/d02/ssteinig/python_pkg`
 - `suite_info` module failed
 - I manually reset state to "succeeded" (via right-click) and the rest of the suite appeared to run fine!

#### Validation of new weights
- I copied the suite output `~/cylc-run/u-bp550/share/data/20130105T0000Z` and Charlie's previous weights `/home/d05/cwilliams/gc31/coupling_weights_round2` to the BRIDGE machine [[silurian]] (`/home/bridge/wb19586/hadgem3/weights`)
- There are 27 files in total, 26 of those are in netCDF format. The only non-netCDF file is `atmo_mask_fracarea_anc_ns`, but it has a netCDF pendant `atmo_mask_fracarea_anc_ns` only containing the land-sea mask on UM grid. So I assume both files are identical and only compare the remaining 26 netCDF files.
- script `compare_oasis_weights.sh` uses [[CDO]] to check differences between the two different sets of weight files. DIfferences are:
    1. files `areas.nc`, `grids.nc` and `masks.nc` don't include `uor1*` and `vor1*` variables (ocean U and V components)
    2. Latitude orientation in file `atmo_mask_fracarea_anc_ns.nc` reversed. This is also the case for the respective UM-format file `atmo_mask_fracarea_anc_ns`. According to Charlie's guide, this file is needed as input to ancillary suite to create UM ancils with correct land-sea mask.
    3. All other files are also not identical, but absolute and relative differences are limited to specific variables and are very small (normally < 1e-10). Probably fine? Related to machine precision?